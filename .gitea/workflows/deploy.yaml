name: Panel Production Deploy (SSH Mode)
on:
  push:
    branches:
      - rezishon-patch-1
     
jobs:
  deploy:
    runs-on: local-host 
    steps:
      - name: Execute Remote Commands via SSH
        uses: https://github.com/appleboy/ssh-action@master
        with:
          host: 192.168.1.9  # Use your server's internal IP
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2280
          script: |
            # 1. Setup Environment (Node v24)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            nvm use 24

            # 2. Navigate and Update Source
            cd /home/bpt-user/Downloads/Panel
            git fetch origin main
            git reset --hard origin/main  # Cleaner than stash; forces host to match Git exactly
            
            # 3. Update Source
            cd $REPO_DIR
            git fetch origin main
            # Using reset --hard is safer for automation than pull --force
            git reset --hard origin/main 

            # 4. Build Process
            if npm ci; then
              echo "Packages installed successfully"
            else
              echo "npm ci failed" && exit 1
            fi

            if ng build --output-hashing=all --configuration production; then
              echo "Build successful"
            else
              echo "Build failed" && exit 1
            fi

            # 6. Reload Nginx
            if sudo nginx -s reload; then
              echo "Nginx reloaded successfully"
            else
              echo "Nginx reload failed" && exit 1
            fi
            