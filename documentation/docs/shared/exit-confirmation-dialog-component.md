---
sidebar_position: 15
title: ExitConfirmationDialog
---

# ⚠️ ExitConfirmationDialog Component

کامپوننت `ExitConfirmationDialogComponent` یک ابزار ایمنی است که برای جلوگیری از خروج ناخواسته کاربر از یک صفحه حاوی **تغییرات ذخیره‌نشده** (فرم‌های `dirty`) طراحی شده است. این کامپوننت با استفاده از رویدادهای مرورگر، خروج کاربر از طریق دکمه **Back** یا بستن تب/مرورگر را متوقف کرده و یک دیالوگ تأیید نمایش می‌دهد.

این منطق تنها در محیط **Production** فعال می‌شود (بررسی `environment.production`).

---

## ⚙️ ورودی‌ها و وابستگی‌ها

این کامپوننت بدون ورودی (Input) است، اما به یک فیلد حالت داخلی و سرویس PrimeNG وابسته است:

| ویژگی                 | نوع           | توضیح                                                                                                                   |
| :-------------------- | :------------ | :---------------------------------------------------------------------------------------------------------------------- |
| `formDirty`           | `boolean`     | **وضعیت داخلی.** باید توسط کامپوننت والد تنظیم شود. اگر `true` باشد، تغییرات ذخیره‌نشده وجود دارد و دیالوگ فعال می‌شود. |
| `ConfirmationService` | سرویس PrimeNG | سرویس تزریق شده برای نمایش دیالوگ مودال تأیید.                                                                          |

---

## 🛡️ مدیریت رویدادهای مرورگر

این کامپوننت دو رویداد اصلی مرورگر را مدیریت می‌کند تا خروج کاربر را رصد و متوقف کند:

### ۱. جلوگیری از بستن تب/بارگذاری مجدد (`beforeunload`)

| متد              | رویداد مرورگر         | توضیح عملکرد                                                                                                                                                                  |
| :--------------- | :-------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `onBeforeUnload` | `window:beforeunload` | اگر `formDirty` باشد، متد `preventDefault()` و تنظیم `event.returnValue = ''` را فراخوانی می‌کند. این کار یک هشدار استاندارد مرورگر (native) را برای تأیید خروج نمایش می‌دهد. |

### ۲. مدیریت دکمه بازگشت مرورگر (`popstate`)

| متد                        | رویداد مرورگر       | توضیح عملکرد                                                                                                                                                                                                                                                                                 |
| :------------------------- | :------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`ngOnInit()`**           | `history.pushState` | در ابتدا یک حالت تاریخچه (History State) پوش می‌کند تا دکمه "بازگشت" را اصطلاحاً "Trap" کند و اولین کلیک به صفحه قبلی هدایت نشود.                                                                                                                                                            |
| **`onPopState`**           | `window:popstate`   | این رویداد هنگام کلیک روی دکمه Back فعال می‌شود.                                                                                                                                                                                                                                             |
| **اگر `formDirty` باشد:**  |                     | \* حالت تاریخچه را دوباره پوش می‌کند تا کاربر در همان صفحه بماند. \* دیالوگ PrimeNG را نمایش می‌دهد. \* **قبول (Accept):** شنونده `popstate` حذف شده و سپس `history.go(-2)` اجرا می‌شود تا کاربر به صفحه قبل از Trap هدایت شود. \* **رد (Reject):** دیالوگ بسته شده و کاربر در صفحه می‌ماند. |
| **اگر `formDirty` نباشد:** |                     | شنونده `popstate` حذف شده و `history.back()` برای خروج طبیعی فراخوانی می‌شود.                                                                                                                                                                                                                |
