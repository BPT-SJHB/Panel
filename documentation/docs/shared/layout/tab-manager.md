---
sidebar_position: 19
title: TabManager
---

# 📑 TabManager Component

کامپوننت `TabManagerComponent` مسئول مدیریت ساختار **چند تب (Multi-Tab)** در رابط کاربری اصلی برنامه است. این کامپوننت امکان باز کردن، انتخاب و بستن تب‌های مختلف به‌صورت پویا را فراهم می‌کند. هر تب می‌تواند حاوی کامپوننت‌های مختلف (Main Component) و همچنین تب‌های فرعی (Sub-Tabs) باشد.

این کامپوننت ترکیبی از State Management انگولار (NgRx) و Reactivity انگولار (Signals/Effects) را برای مدیریت حالت‌های پیچیده رابط کاربری پیاده‌سازی می‌کند.

---

## 💎 تایپ‌ها و ساختار داده‌ها (مدل‌های اصلی)

این کامپوننت برای تعریف ساختار تب‌ها و داده‌های ورودی خود از اینترفیس‌ها و تایپ‌های زیر استفاده می‌کند:

### ۱. `DynamicTab`

این اینترفیس کامل‌ترین تعریف برای یک تب فعال در حافظه کامپوننت `TabManager` است.

| ویژگی             | نوع                              | توضیح                                                                                                                                                      |
| :---------------- | :------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `id`              | `string`                         | شناسه منحصر به فرد تب (معمولاً UUID یا شناسه داده).                                                                                                        |
| `title`           | `string`                         | عنوان قابل نمایش تب.                                                                                                                                       |
| `icon`            | `string`                         | کلاس آیکون برای نمایش در نوار تب (مانند `pi pi-home`).                                                                                                     |
| `closeable`       | `boolean`                        | آیا کاربر مجاز به بستن این تب است یا خیر (مثل تب "صفحه اصلی" که `false` است).                                                                              |
| `sharedSignal`    | `WritableSignal<any>`            | **اختیاری.** یک سیگنال که می‌تواند برای به‌اشتراک‌گذاری وضعیت بین کامپوننت‌های داخلی تب استفاده شود.                                                       |
| `cachedComponent` | `Map<number, ComponentRef<any>>` | یک Map که نمونه‌های کامپوننت‌های ایجاد شده به صورت پویا را ذخیره می‌کند تا از نشت حافظه جلوگیری شود و در هنگام جابجایی بین Sub-Tabها سریعاً بارگذاری شوند. |
| `selectedSubTab`  | `number`                         | اندیس تب فرعی (Sub-Tab) فعال در حال حاضر.                                                                                                                  |
| `config`          | `TabConfig`                      | پیکربندی ثابت کامپوننت اصلی که در این تب قرار می‌گیرد، از `TabComponentRegistry`.                                                                          |

### ۲. `TabItem` (مدل ذخیره‌سازی)

این اینترفیس برای نمایش داده‌های تب در سطوح بالاتر (مثلاً در استور NgRx برای بازیابی وضعیت تب‌ها) استفاده می‌شود.

| ویژگی       | نوع               | توضیح                                              |
| :---------- | :---------------- | :------------------------------------------------- |
| `id`        | `number`          | شناسه تب.                                          |
| `title`     | `string`          | عنوان تب.                                          |
| `closable`  | `boolean`         | قابلیت بستن تب.                                    |
| `component` | `TabComponentKey` | کلید مربوط به کامپوننت که باید در این تب رندر شود. |
| `active`    | `boolean`         | آیا این تب، تب فعال فعلی است یا خیر.               |

---

## ⚙️ معماری و مدیریت حالت

این کامپوننت حالت‌های اصلی خود را با استفاده از **`Map`** و **`Signals`** مدیریت می‌کند:

### ۱. `tabs` (Map)

- **نوع:** `Map<string, DynamicTab>`
- **وظیفه:** ذخیره تمام تب‌های باز در سیستم. کلید، `id` تب است.
- **مقدار اولیه:** حاوی یک تب ثابت برای **صفحه اصلی** (`DEFAULT_MAIN_TAB_ID`) که قابل بستن نیست.

### ۲. `selectTab` (Signal)

- **نوع:** `signal<DynamicTab>`
- **وظیفه:** نگهداری تب فعال و انتخاب‌شده فعلی.
- **Effect:** یک `effect` به این سیگنال متصل است که بلافاصله پس از تغییر `selectTab()`، متد `contentManager().loadTabContent(tab)` را فراخوانی می‌کند تا محتوای تب جدید در فضای اصلی بارگذاری شود.

### ۳. `hiddenSubTab` (Signal)

- **وظیفه:** کنترل نمایش/عدم نمایش تب‌های فرعی (Sub-Tabs) در زیر نوار ابزار اصلی، بر اساس وضعیت محتوای فعلی که از استور (`selectContent`) خوانده می‌شود.

---

## 🔄 جریان‌های داده و همگام‌سازی

- **ایجاد و انتخاب تب (`createOrSelectTab`):** این متد به سابسکریپشن NgRx بر روی سِلکتور **`selectorNewTab`** متصل است و تب‌ها را بر اساس داده‌های دریافتی از استور ایجاد یا انتخاب می‌کند.
- **بستن تب (`closeTab`):** تب را از Map حذف کرده، منابع آن را با **`destroyTabResources`** آزاد می‌کند، و به تب جایگزین (Fallback) سوییچ می‌کند.
- **مدیریت تغییر اندازه و Redraw تب‌ها:** از `HostListener` و `resize$` Subject برای وادار کردن کامپوننت PrimeNG Tabs به محاسبه مجدد (Redraw) هنگام تغییر اندازه پنجره استفاده می‌کند تا نمایش Sub-Tabs همیشه صحیح باشد.

---

## 💾 مدیریت حافظه نهان (Caching)

- **`cachedComponent`**: هر تب در این Map، نمونه‌های کامپوننت‌های داینامیک داخلی خود را ذخیره می‌کند.
- **`destroyTabResources(tab)`**: هنگام بستن یک تب، این متد تضمین می‌کند که تمام کامپوننت‌های ذخیره شده در `cachedComponent` با فراخوانی **`comp.destroy()`** از بین بروند تا از **نشت حافظه (Memory Leaks)** جلوگیری شود.

---

## 📍 حرکت روان نوار تب

- **`ngAfterViewChecked()`**: این Hook تضمین می‌کند که پس از هر بار تغییر تب فعال، نوار تب به صورت افقی حرکت کند (`scrollIntoView`) تا تب جدید کاملاً در دید کاربر قرار گیرد.

### 🛠️ توابع و متدهای `TabManagerComponent`

این بخش توابع و متدهای اصلی را که وظیفه مدیریت تعاملات کاربری و همگام‌سازی وضعیت تب‌ها را بر عهده دارند، شرح می‌دهد.

### توابع عمومی (Public Methods)

این توابع مستقیماً توسط رخدادهای رابط کاربری (مانند کلیک روی تب‌ها) فراخوانی می‌شوند.

| متد                                           | نوع    | توضیح                                                                                                                                                                                                                                 |
| :-------------------------------------------- | :----- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **`onClickTab(tab: DynamicTab)`**             | `void` | هنگام **کلیک** روی یک تب در نوار اصلی فراخوانی می‌شود. این متد `selectTab` را به‌روزرسانی می‌کند تا تب جدید فعال شود. اگر روی تب فعال کلیک شود، محتوای تب فعال را مجدداً بارگذاری می‌کند (`loadTabContent`).                          |
| **`onSubTabChange(index: string \| number)`** | `void` | هنگام تغییر تب‌های فرعی (Sub-Tabs) در داخل یک تب اصلی فراخوانی می‌شود. این متد `selectedSubTab` در آبجکت `selectTab()` را به‌روزرسانی می‌کند.                                                                                         |
| **`createOrSelectTab(tabData: TabData)`**     | `void` | تابع هسته‌ای که از طریق سابسکریپشن NgRx فراخوانی می‌شود. اگر تبی با شناسه داده شده وجود داشته باشد، آن را انتخاب می‌کند؛ در غیر این صورت، یک **تب جدید پویا** ایجاد کرده، آن را به `this.tabs` اضافه می‌کند و سپس آن را فعال می‌سازد. |
| **`closeTab(id: string)`**                    | `void` | یک تب با `id` مشخص را می‌بندد. ابتدا منابع ذخیره‌شده آن را آزاد می‌کند (`destroyTabResources`)، سپس تب را از `this.tabs` حذف کرده و یک تب جایگزین را انتخاب می‌کند.                                                                   |
| **`onWindowResized()`**                       | `void` | یک Listener برای رخداد تغییر اندازه پنجره است (`@HostListener`). هر بار که پنجره تغییر اندازه می‌دهد، `resize$` Subject را فعال می‌کند. این کار برای اصلاح نمایش تب‌های فرعی PrimeNG ضروری است.                                       |

---

### توابع کمکی خصوصی (Private Helpers)

این توابع منطق پیچیده مدیریت حالت و حافظه را پیاده‌سازی می‌کنند و مستقیماً فراخوانی نمی‌شوند.

| متد                                        | نوع                  | توضیح                                                                                                                                                                                                                                                                                      |
| :----------------------------------------- | :------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`getFallbackTab(closedTabId: string)`**  | `DynamicTab \| null` | پس از بستن تب فعال، این متد **تب جایگزین** را پیدا می‌کند. منطق آن به این صورت است که تب قبلی در لیست را انتخاب می‌کند و اگر وجود نداشت، اولین تب (صفحه اصلی) را انتخاب می‌کند.                                                                                                            |
| **`destroyTabResources(tab: DynamicTab)`** | `void`               | مسئول **آزاد کردن منابع حافظه** یک تب بسته شده است. تمام نمونه‌های کامپوننت ذخیره‌شده (`cachedComponent`) را مرور کرده و متد `destroy()` را روی آن‌ها فراخوانی می‌کند تا از نشت حافظه جلوگیری شود.                                                                                         |
| **`resetTabs()`**                          | `void`               | **تمام تب‌های باز را پاکسازی می‌کند** و تنها تب پیش‌فرض (صفحه اصلی) را دوباره تنظیم و فعال می‌سازد. این تابع تنها یک بار هنگام راه‌اندازی اولیه و قبل از بارگذاری محتوای اولین تب توسط `effect` فراخوانی می‌شود تا از بارگذاری تصادفی محتوای تب پیش‌فرض جلوگیری شود (`tabsCached = true`). |

---

### مدیریت چرخه‌حیات (Lifecycle & Subscriptions)

| متد                        | نوع                 | توضیح                                                                                                                                                                                  |
| :------------------------- | :------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`constructor()`**        | `effect`            | یک `effect` انگولار تعریف می‌کند که هر زمان `selectTab()` تغییر کند، محتوای جدید تب را با فراخوانی `manager.loadTabContent()` بارگذاری می‌کند.                                         |
| **`ngOnInit()`**           | `Subject.subscribe` | سابسکریپشن مربوط به **`resize$`** را راه‌اندازی می‌کند. این سابسکریپشن با `auditTime` فرکانس اجرای منطق اصلاحی UI (برای تب‌های فرعی) را کنترل می‌کند.                                  |
| **`ngAfterViewInit()`**    | `Store.select`      | به دو سلکتور NgRx سابسکریپشن می‌دهد: ۱. **`selectorNewTab`** برای ایجاد تب‌های جدید. ۲. **`selectContent`** برای مدیریت حالت نمایش تب‌های فرعی (`hiddenSubTab`).                       |
| **`ngAfterViewChecked()`** | `scrollIntoView`    | پس از هر به‌روزرسانی نمایشی، بررسی می‌کند که آیا تب فعال تغییر کرده است یا نه. اگر تغییر کرده باشد، با استفاده از `scrollIntoView` نوار تب را به صورت روان به سمت تب فعال حرکت می‌دهد. |
| **`ngOnDestroy()`**        | `Subject.complete`  | تمام منابع RxJS و `cachedComponent` را پاکسازی می‌کند تا از نشت حافظه در هنگام نابودی کامپوننت جلوگیری شود.                                                                            |
